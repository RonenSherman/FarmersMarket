<!DOCTYPE html>
<html>
<head>
    <title>Debug Vendor Payment</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .result { background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 3px; margin: 10px 0; }
        .error { background: #ffebee; border-color: #f44336; color: #c62828; }
        .success { background: #e8f5e8; border-color: #4caf50; color: #2e7d32; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a8b; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; white-space: pre-wrap; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; width: 400px; }
        .diagnosis { background: #fff3cd; border: 1px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Debug Vendor Payment Connection</h1>
        
        <div class="test-section">
            <h2>Test Vendor Payment Debug</h2>
            <p>Enter the vendor ID that's failing to load Square config:</p>
            <input type="text" id="vendorId" placeholder="Enter vendor ID (e.g., 98d1d158-3988-4c27-a50d-81e278f11bc4)" value="98d1d158-3988-4c27-a50d-81e278f11bc4">
            <br>
            <button onclick="debugVendor()">Debug Vendor Payment</button>
            <div id="debugResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>Test OAuth Config (Same as Square Widget)</h2>
            <p>This tests the same endpoint the Square widget calls:</p>
            <input type="text" id="configVendorId" placeholder="Enter vendor ID" value="98d1d158-3988-4c27-a50d-81e278f11bc4">
            <br>
            <button onclick="testOAuthConfig()">Test OAuth Config</button>
            <div id="configResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>Quick Test Known Working Vendor</h2>
            <p>Test the vendor we know has Square connected:</p>
            <button onclick="testKnownVendor()">Test Known Working Vendor (f2d49276-652f-4f5f-a8ec-286d7006ff01)</button>
            <div id="knownResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const baseUrl = 'https://farmers-marketrs-6tnvluui9-ronen-shermans-projects.vercel.app';
        
        async function debugVendor() {
            const vendorId = document.getElementById('vendorId').value;
            const resultDiv = document.getElementById('debugResult');
            
            if (!vendorId) {
                showResult(resultDiv, 'Please enter a vendor ID', 'error');
                return;
            }
            
            try {
                showResult(resultDiv, 'Testing vendor payment debug...', 'info');
                
                const response = await fetch(`${baseUrl}/api/debug-vendor-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vendorId })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let diagnosis = '';
                    if (data.diagnosis) {
                        diagnosis = `
                        <div class="diagnosis">
                            <h3>üîç Diagnosis:</h3>
                            <ul>
                                <li><strong>Vendor says connected:</strong> ${data.diagnosis.vendorSaysConnected}</li>
                                <li><strong>Actual active connections:</strong> ${data.diagnosis.actualActiveConnections}</li>
                                <li><strong>Has Square connection:</strong> ${data.diagnosis.hasSquareConnection}</li>
                                <li><strong>Has ACTIVE Square connection:</strong> ${data.diagnosis.hasActiveSquareConnection}</li>
                                <li><strong>Mismatch detected:</strong> ${data.diagnosis.mismatchDetected}</li>
                            </ul>
                        </div>`;
                    }
                    
                    showResult(resultDiv, `
                        <h3>‚úÖ Debug Results:</h3>
                        ${diagnosis}
                        <h4>Vendor Info:</h4>
                        <pre>${JSON.stringify(data.vendorInfo, null, 2)}</pre>
                        <h4>Payment Connections Summary:</h4>
                        <pre>${JSON.stringify(data.paymentConnections, null, 2)}</pre>
                    `, 'success');
                } else {
                    showResult(resultDiv, `‚ùå Error: ${data.error}\n\nDetails: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(resultDiv, `‚ùå Network Error: ${error.message}`, 'error');
            }
        }
        
        async function testOAuthConfig() {
            const vendorId = document.getElementById('configVendorId').value;
            const resultDiv = document.getElementById('configResult');
            
            if (!vendorId) {
                showResult(resultDiv, 'Please enter a vendor ID', 'error');
                return;
            }
            
            try {
                showResult(resultDiv, 'Testing OAuth config (same as Square widget)...', 'info');
                
                const response = await fetch(`${baseUrl}/api/oauth/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vendorId, provider: 'square' })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult(resultDiv, `‚úÖ OAuth Config Success:\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(resultDiv, `‚ùå OAuth Config Error (${response.status}):\n\n${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(resultDiv, `‚ùå Network Error: ${error.message}`, 'error');
            }
        }
        
        async function testKnownVendor() {
            const resultDiv = document.getElementById('knownResult');
            const knownVendorId = 'f2d49276-652f-4f5f-a8ec-286d7006ff01';
            
            try {
                showResult(resultDiv, 'Testing known working vendor...', 'info');
                
                const response = await fetch(`${baseUrl}/api/debug-vendor-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vendorId: knownVendorId })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult(resultDiv, `‚úÖ Known Vendor Debug Results:\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(resultDiv, `‚ùå Known Vendor Error: ${data.error}\n\nDetails: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(resultDiv, `‚ùå Network Error: ${error.message}`, 'error');
            }
        }
        
        function showResult(element, message, type) {
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.innerHTML = `<pre>${message}</pre>`;
        }
    </script>
</body>
</html> 